. /etc/profile
if [ ! -f /usr/bin/chef-client ]; then
   wget -q -O /tmp/<%= @installer %> http://<%= node['ipaddress'] %>/chef-full-stack/<%= @release %>/<%= @installer %>
   dpkg -i /tmp/<%= @installer %>
fi

mkdir -p /etc/chef

cat > /etc/chef/client.rb <<EOF
log_level        :info
log_location     STDOUT

chef_server_url  '<%= Chef::Config[:chef_server_url] %>'
validation_client_name '<%= Chef::Config[:validation_client_name] %>'

<% if @http_proxy %>http_proxy 'http://<%= @http_proxy %>'<% end %>
<% if @https_proxy %>http_proxy 'https://<%= @https_proxy %>'<% end %>
<% if @http_proxy_user %>http_proxy_user 'http://<%= @http_proxy_user %>'<% end %>
<% if @http_proxy_pass %>http_proxy_pass 'http://<%= @http_proxy_pass %>'<% end %>
EOF

cat > /etc/chef/first-boot.json <<EOF
{
<% if @run_list %>"run_list": [ <%= @run_list.to_s %> ]<% end %>
}
EOF

wget -O /etc/chef/validation.pem http://<%= node['ipaddress'] %>/validation.pem

/usr/bin/chef-client<% if @environment %> -E <%= @environment %><% end %> -j /etc/chef/first-boot.json

rm /tmp/<%= @installer %>

#enforce the pxe-booted NIC as eth0
MAC=$(ip addr show <%= @interface %> | grep 'link/ether' | cut -d' ' -f6)
cat <<EOF > /etc/udev/rules.d/70-persistent-net.rules
# This file was generated by Chef to ensure PXE NIC stays as eth0
SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*", ATTR{address}=="${MAC}", ATTR{dev_id}=="0x0", ATTR{type}=="1", KERNEL=="eth*", NAME="eth0"
EOF
